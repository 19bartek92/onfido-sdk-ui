<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Onfido SDK Demo</title>
    <meta name="viewport" content="width=device-width, minimal-ui" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="format-detection" content="telephone=no" />
    <% if (process.env.NODE_ENV !== "development"){ %>
    <meta
      http-equiv="Content-Security-Policy"
      content="
      default-src 'self' https://assets.onfido.com;
      script-src 'self' https://www.woopra.com https://assets.onfido.com https://sentry.io;
      style-src 'self' 'unsafe-inline' https://assets.onfido.com;
      connect-src blob: *.onfido.com wss://*.onfido.com *.dev.onfido.xyz wss://*.dev.onfido.xyz https://www.woopra.com https://sentry.io;
      img-src 'self' data: blob: https://lipis.github.io/flag-icon-css/;
      media-src blob:;
      object-src 'self' blob:;
      frame-src 'self' data: blob:;
    "
    />
    <% } %>
    <script src="https://static.opentok.com/v2/js/opentok.min.js"></script>
    <script>
      var archiveId
      var apiKey = '46976504'
      var sessionId
      var token
      ;(function () {
        fetch('https://localhost:8090/room/session', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json',
          },
          mode: 'cors'
        })
          .then((response) => response.json())
          .then((data) => {
            sessionId = data.sessionId
            token = data.token

            var session = OT.initSession(apiKey, sessionId)
            // create publisher
            var publisher = OT.initPublisher()
            session.connect(token, function (err) {
              session.publish(publisher)
            })

            session.on('streamCreated', function (event) {
              session.subscribe(event.stream)
            })
          })
      })()

      function startRecording() {
        console.log('calling start')
        fetch('https://localhost:8090/archive/start', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ sessionId: sessionId }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log('data', data)
            archiveId = data.id
          })
      }

      function stopRecording() {
        console.log('calling stop')
        fetch(`https://localhost:8090/archive/${archiveId}/stop`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ sessionId: sessionId }),
        })
      }

      function play() {
        console.log('calling play')
        fetch(`https://localhost:8090/archive/${archiveId}`, {
          method: 'GET'
        }).then((response) => response.json()).then((data) => {
          console.log(data)
          const video = document.getElementById('openTokVideo')
          console.log(video)
          video.src = data.url
        })
      }
    </script>
    <style type="text/css">
      html,
      body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #demo-app {
        width: 100%;
        height: 100%;
        box-sizing: border-box;
        text-align: center;
      }
      .container {
        width: 100%;
        height: 100%;
      }
      @media (min-width: 480px) {
        #demo-app {
          position: relative;
          padding-top: 5%;
        }
      }
    </style>
  </head>
  <body>
    <div id="demo-app"></div>
    <button onclick="startRecording()">Start</button>
    <button onclick="stopRecording()">Stop</button>
    <button onclick="play()">Play</button>
    <video id='openTokVideo' controls/>
  </body>
</html>
